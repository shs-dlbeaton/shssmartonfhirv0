<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="assets/css/styles.css">
    <meta charset="utf-8">
</head>
<body>
<header class="container">
    <div id="messages" class="alert alert-warning alert-dismissible text-center" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <!--TODO: REPLACE DUMMY CONTENT-->
        <strong>Warning!</strong> Better check yourself, you're not looking too good.
        <button class="btn btn-warning" type="button" data-toggle="modal" data-target="#patientSyncModal">Fix it</button>
    </div>
</header>
<div class="jumbotron text-center" style="margin-bottom:0">
    <button type="button" class="btn btn-primary" onclick="returnClient()">fhir payload
    </button>
    <button type="button" class="btn btn-warning" onclick="showLaunchParameters()">debug
    </button>
    <div id="main" style="display: none">
        <p>testing change</p>
        <h4>smart on fhir Patient launch context</h4>
        <div id="patient">Loading...</div>
        <h4>smart on fhir User launch context</h4>
        <div id="user">Loading...</div>
        <h4>smart on fhir Encounter launch context</h4>
        <div id="encounterLaunchContext">Loading...</div>
        <h4>Encounter history</h4>
        <div id="encounterHistory">Loading...</div>
        <h4>Organization</h4>
        <div id="organization">Loading...</div>
        <h4>Location</h4>
        <div id="location">Loading...</div>
        <h4>Practitioner</h4>
        <div id="practitioner">Loading...</div>
        <h4>Observation</h4>
        <div id="observation">Loading...</div>
        <h4>DocumentReference</h4>
        <div id="documentReference">Loading...</div>
        <h4>MedicationRequest</h4>
        <div id="medicationRequest">Loading...</div>
        <h4>ServiceRequest</h4>
        <div id="serviceRequest">Loading...</div>
        <h4>DiagnosticReport</h4>
        <div id="diagnosticReport">Loading...</div>
        <h4>Consent</h4>
        <div id="consent">Loading...</div>
        <h4>FHIR Client</h4>
        <div id="fhirClient">Loading...</div>
    </div>
    <script type="text/javascript">
        var clientGlobalScope = {};
        FHIR.oauth2.ready().then(function (fhirBundle) {
            // Render the current patient (or any error)
            fhirBundle.fhirBundle = {};
            fhirBundle.patient.read().then(
                function (pt) {
                    console.log(JSON.stringify(fhirBundle));
                    document.getElementById('patient').innerText = JSON.stringify(pt, null, 4);
                    fhirBundle.fhirBundle.patientResource = pt;
                },
                function (error) {
                    document.getElementById('patient').innerText = error.stack;
                }
            );

            // Render the current encounter (or any error)
            fhirBundle.encounter.read().then(
                function (encounter) {
                    document.getElementById('encounterLaunchContext').innerText = JSON.stringify(encounter, null, 4);
                    fhirBundle.fhirBundle.Encounter = encounter;
                },
                function (error) {
                    document.getElementById('encounterLaunchContext').innerText = error.stack;
                }
            );

            fhirBundle.user.read().then(
                function (user) {
                    document.getElementById('user').innerText = JSON.stringify(user, null, 4);
                    fhirBundle.fhirBundle.userResource = user;
                },
                function (error) {
                    document.getElementById('user').innerText = error.stack;
                }
            );

            // Get Encounter History for selected patient
            fhirBundle.request('/Encounter?subject=Patient/' + fhirBundle.patient.id, {})

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No encounter found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current encounter (or any error)
                .then(
                    function (encounterByPatientId) {
                        document.getElementById('encounterHistory').innerText = JSON.stringify(encounterByPatientId, null, 4);
                        fhirBundle.fhirBundle.EncounterList = encounterByPatientId;
                    },
                    function (error) {
                        alert('Issue Fetching Encounter by PatientId');
                        document.getElementById('encounterHistory').innerText = error.stack;
                    }
                );


            fhirBundle.request('/Observation?subject=Patient/' + fhirBundle.patient.id + '&category=http://hl7.org/fhir/observation-category|laboratory', { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No observations found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current observation (or any error)
                .then(
                    function (observation) {
                        document.getElementById('observation').innerText = JSON.stringify(observation, null, 4);
                        fhirBundle.fhirBundle.observation = observation;
                    },
                    function (error) {
                        alert('Issue Fetching observation by PatientId');
                        document.getElementById('observation').innerText = error.stack;
                    }
                );


            fhirBundle.request('/DocumentReference?patient=' + fhirBundle.patient.id, {})

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No DocumentReference found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current allergy intolerance (or any error)
                .then(
                    function (documentReference) {
                        document.getElementById('documentReference').innerText = JSON.stringify(documentReference, null, 4);
                        fhirBundle.fhirBundle.documentReference = documentReference;
                    },
                    function (error) {
                        alert('Issue Fetching documentReference by PatientId');
                        document.getElementById('documentReference').innerText = error.stack;
                    }
                );

            // Get Organization for the selected patient
            fhirBundle.request('/Patient?_id=' + fhirBundle.patient.id, {
                resolveReferences: ['managingOrganization'],
                graph: true
            })

            // Reject if no organization is found
                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No organization found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current organization(or any error)
                .then(
                    function (encounter) {
                        document.getElementById('organization').innerText = JSON.stringify(encounter[0].resource.managingOrganization, null, 4);
                        fhirBundle.fhirBundle.Organization = encounter[0].resource.managingOrganization;
                    },
                    function (error) {
                        alert('Issue Fetching Organization');
                        document.getElementById('organization').innerText = error.stack;
                    }
                );


            fhirBundle.request('/Consent?patient=' + fhirBundle.patient.id + '&status=active', { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No Consent found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current consent (or any error)
                .then(
                    function (consent) {
                        document.getElementById('consent').innerText = JSON.stringify(consent, null, 4);
                        fhirBundle.fhirBundle.Consent = consent;
                    },
                    function (error) {
                        alert('Issue fetching Consent by PatientId');
                        document.getElementById('consent').innerText = error.stack;
                    }
                );

            fhirBundle.request('/MedicationRequest?patient=' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No Appointment found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current medicationRequest (or any error)
                .then(
                    function (medicationRequest) {
                        document.getElementById('medicationRequest').innerText = JSON.stringify(medicationRequest, null, 4);
                        fhirBundle.fhirBundle.MedicationRequest = medicationRequest;
                    },
                    function (error) {
                        alert('Issue fetching MedicationRequest by PatientId');
                        document.getElementById('medicationRequest').innerText = error.stack;
                    }
                );

            fhirBundle.request('/ServiceRequest?patient=' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No ServiceRequest found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current service request (or any error)
                .then(
                    function (serviceRequest) {
                        document.getElementById('serviceRequest').innerText = JSON.stringify(serviceRequest, null, 4);
                        fhirBundle.fhirBundle.ServiceRequest = serviceRequest;
                    },
                    function (error) {
                        alert('Issue fetching Service Request by PatientId');
                        document.getElementById('serviceRequest').innerText = error.stack;
                    }
                );

            fhirBundle.request('/DiagnosticReport?patient=' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No DiagnosticReport found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current appointment (or any error)
                .then(
                    function (diagnosticReport) {
                        document.getElementById('diagnosticReport').innerText = JSON.stringify(diagnosticReport, null, 4);
                        fhirBundle.fhirBundle.DiagnosticReport = diagnosticReport;
                    },
                    function (error) {
                        alert('Issue fetching DiagnosticReport by PatientId');
                        document.getElementById('diagnosticReport').innerText = error.stack;
                    }
                );


            // Get Location for the selected encounter
            fhirBundle.request('/Encounter?_id=' + fhirBundle.encounter.id, {
                resolveReferences: ['location'],
                graph: true
            })

            // Reject if no location is found
                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No location found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current location (or any error)
                .then(
                    function (encounter) {
                        document.getElementById('location').innerText = JSON.stringify(encounter[0].resource.location, null, 4);
                        fhirBundle.fhirBundle.Location = encounter[0].resource.location;
                    },
                    function (error) {
                        alert('Issue Fetching Location');
                        document.getElementById('location').innerText = error.stack;
                    }
                );


            // Get Practitioners for the selected encounter
            fhirBundle.request('/Encounter?_id=' + fhirBundle.encounter.id, {
                resolveReferences: ['subject'],
                graph: true
            })


            // Reject if no Practitioners are found
                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No practitioners for the selected patient');
                    }
                    return data.entry;
                })


                // Get Practitioners for the selected encounter
                .then(
                    function (encounter) {
                        document.getElementById('practitioner').innerText = JSON.stringify(encounter, null, 4);
                        fhirBundle.fhirBundle.Practitioner = encounter;
                    },
                    function (error) {
                        document.getElementById('practitioner').innerText = error.stack;
                    }
                );
            clientGlobalScope.client = fhirBundle;

        }).catch(console.error);

        function returnClient() {
            document.getElementById('fhirClient').innerText = JSON.stringify(clientGlobalScope, null, 4);
        };

        function showLaunchParameters() {
            var x = document.getElementById('main');
            if (x.style.display === 'none') {
                x.style.display = 'block';
            } else {
                x.style.display = 'none';
            }
        }
    </script>
</div>
<footer id="app-footer" class="container-fluid">
    <div class="row">
        <div class="col-sm-4 col-sm-offset-1">
            <img src="assets/img/Strata-logo-300w.png" alt="Strata Health Solutions Inc." width="200px"/>
        </div>
        <div class="col-sm-4 col-sm-offset-3">
            <ul id="support-contact-list">
                <li>
                    <span class="glyphicon glyphicon-globe pad-right-5"></span><a href="https://stratahealth.com" target="_blank">Strata Health Solutions Inc.</a>
                </li>
                <li>
                    <span class="glyphicon glyphicon-earphone pad-right-5"></span><a href="tel:+18665565005">1 (866) 556-5005</a>
                </li>
                <li>
                    <span class="glyphicon glyphicon-envelope pad-right-5"></span><a href="mailto:support@stratahealth.com?subject=Support%20Request">support@stratahealth.com</a>
                </li>
            </ul>
        </div>
    </div>
</footer>
<div class="modal fade" id="patientSyncModal" tabindex="-1" role="dialog" aria-labelledby="patientSyncModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="patientSyncModalLabel">Patient Details Mis-match</h4>
            </div>
            <div id="patientSyncModalBody" class="modal-body">
                <div class="row">
                    <!--TODO: REPLACE DUMMY CONTENT FOR MODAL-->
                    <div id="EMRPatient" class="col-sm-6">
                        <ul>
                            <li>Name: Last Name, First Name</li>
                            <li>MRN: 1234567890</li>
                            <li>D.O.B: 09/08/1988</li>
                        </ul>
                    </div>
                    <div id="pathwaysPatient" class="col-sm-6">
                        <ul>
                            <li>Name: Last Name, First Name</li>
                            <li>MRN: 1234567891</li>
                            <li>D.O.B: 09/08/1989</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
