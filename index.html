<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>SHS SMART ON FHIR</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <style>
        #patient, #organization, #location, #practitioner, #encounterByPatientId, #encounterLaunchContext, #observation, #documentReference, #appointment, #allergyIntolerance, #headers {
            font-family: Monaco, monospace;
            white-space: pre;
            font-size: 13px;
            height: 30vh;
            overflow: scroll;
            border: 1px solid #CCC;
        }

        body {
            padding: 20px;
            font: 1em Helvetica Neue, Helvetica, Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        p {
            margin: 0 0 1em 0;
        }

        .container {
            border: 5px solid rgb(30, 144, 255);
            border-radius: .5em;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 500px;
        }

        .item {
            width: 300px;
            height: 30px;
            padding: 10px;
            background-color: rgba(173, 255, 47, 1);
            border: 2px solid rgba(214, 69, 65, 1);
            font-size: 13px;
        }
    </style>
</head>
<body>
<div class="jumbotron text-center" style="margin-bottom:0">
    <img src="images/shs_logo2.png" height="128" width="170"/>
    <h2>SHS PathWays</h2>
    <table>
        <tr>
            <th>
                <button type="button" class="btn btn-primary" onclick="returnClient()">LOOKUP PATIENT</button>
            </th>
        </tr>
    </table>
    <div class="container">
        <h4>Current Patient</h4>
        <div id="patient">Loading...</div>
    </div>
    <div class="container">
        <h4>Encounter fetch from EHR launch context</h4>
        <div id="encounterLaunchContext">Loading...</div>
        <h4>Encounter fetch from Patient FHIR Resource reference</h4>
        <div id="encounterByPatientId">Loading...</div>
    </div>
    <div class="container">
        <h4>Organization fetch from EHR launch context</h4>
        <div id="organization">Loading...</div>
    </div>
    <div class="container">
        <h4>Location</h4>
        <div id="location">Loading...</div>
    </div>
    <div class="container">
        <h4>Practitioners</h4>
        <div id="practitioner">Loading...</div>
    </div>
    <div class="container">
        <h4>Observations</h4>
        <div id="observation">Loading...</div>
    </div>
    <div class="container">
        <h4>Appointments</h4>
        <div id="appointment">Loading...</div>
    </div>
    <div class="container">
        <h4>Allergy Intolerances</h4>
        <div id="allergyIntolerance">Loading...</div>
    </div>
    <div class="container">
        <h4>Document Reference </h4>
        <div id="documentReference">Loading...</div>
    </div>
    <div class="container">
        <h4>Referral Submit Payload Structure </h4>
        <div class="item">Location Resource</div>
        <div class="item">Patient Resource</div>
        <div class="item">Organization Resource</div>
        <div class="item">DocumentReference Resource</div>
        <div class="item">Encounter Resource</div>
        <div class="item">Observation Resource</div>
        <div class="item">Appointment Resource</div>
        <div id="headers">Loading...</div>
    </div>
    <script type="text/javascript">
        var clientGlobalScope = {};
        FHIR.oauth2.ready().then(function (fhirBundle) {
            // Render the current patient (or any error)
            fhirBundle.fhirBundle = {};
            fhirBundle.patient.read().then(
                function (pt) {
                    console.log(pt);
                    document.getElementById('patient').innerText = JSON.stringify(pt, null, 4);
                    fhirBundle.fhirBundle.patientResource = pt;
                    sessionStorage.setItem('_patient', pt);
                },
                function (error) {
                    document.getElementById('patient').innerText = error.stack;
                }
            );

            // Render the current encounter (or any error)
            fhirBundle.encounter.read().then(
                function (encounterLaunchContext) {
                    document.getElementById('encounterLaunchContext').innerText = JSON.stringify(encounterLaunchContext, null, 4);
                    fhirBundle.fhirBundle.encounterLaunchContextResource = encounterLaunchContext;
                },
                function (error) {
                    document.getElementById('encounterLaunchContext').innerText = error.stack;
                }
            );

            // Get Encounter for the selected patient
            fhirBundle.request('/Encounter?subject=Patient/' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No encounter found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current encounter (or any error)
                .then(
                    function (encounterByPatientId) {
                        document.getElementById('encounterByPatientId').innerText = JSON.stringify(encounterByPatientId, null, 4);
                        fhirBundle.fhirBundle.encounterByPatientIdResource = encounterByPatientId;
                        sessionStorage.setItem('_encounterByPatientIdResource', encounterByPatientId);
                    },
                    function (error) {
                        alert('Issue Fetching Encounter by PatientId');
                        document.getElementById('encounterByPatientId').innerText = error.stack;
                    }
                );


            fhirBundle.request('/Observation?subject=Patient/' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No observations found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current observation (or any error)
                .then(
                    function (observation) {
                        document.getElementById('observation').innerText = JSON.stringify(observation, null, 4);
                        fhirBundle.fhirBundle.observation = observation;
                    },
                    function (error) {
                        alert('Issue Fetching observation by PatientId');
                        document.getElementById('observation').innerText = error.stack;
                    }
                );

            fhirBundle.request('/Appointment?patient=' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No appointments found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current appointment (or any error)
                .then(
                    function (appointment) {
                        document.getElementById('appointment').innerText = JSON.stringify(appointment, null, 4);
                        fhirBundle.fhirBundle.appointment = appointment;
                    },
                    function (error) {
                        alert('Issue Fetching appointment by PatientId');
                        document.getElementById('appointment').innerText = error.stack;
                    }
                );

            fhirBundle.request('/AllergyIntolerance?patient=' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No Allergy intolerances found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current allergy intolerance (or any error)
                .then(
                    function (allergyIntolerance) {
                        document.getElementById('allergyIntolerance').innerText = JSON.stringify(allergyIntolerance, null, 4);
                        fhirBundle.fhirBundle.allergyIntolerance = allergyIntolerance;
                    },
                    function (error) {
                        alert('Issue Fetching allergyIntolerance by PatientId');
                        document.getElementById('allergyIntolerance').innerText = error.stack;
                    }
                );

            fhirBundle.request('/DocumentReference?patient=' + fhirBundle.patient.id, { //+ client.patient.id,
            })

                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No DocumentReference found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current allergy intolerance (or any error)
                .then(
                    function (documentReference) {
                        document.getElementById('documentReference').innerText = JSON.stringify(documentReference, null, 4);
                        fhirBundle.fhirBundle.documentReference = documentReference;
                    },
                    function (error) {
                        alert('Issue Fetching documentReference by PatientId');
                        document.getElementById('documentReference').innerText = error.stack;
                    }
                );

            // Get Organization for the selected patient
            fhirBundle.request('/Encounter?_id=' + fhirBundle.encounter.id, { // client.patient.id,
                resolveReferences: ['serviceProvider'],
                graph: true
            })

            // Reject if no organization is found
                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No organization found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current location (or any error)
                .then(
                    function (encounter) {
                        document.getElementById('organization').innerText = JSON.stringify(encounter[0].resource.serviceProvider, null, 4);
                        fhirBundle.fhirBundle.organizationResource = encounter[0].resource.serviceProvider;
                    },
                    function (error) {
                        alert('Issue Fetching Organization');
                        document.getElementById('organization').innerText = error.stack;
                    }
                );

            // Get Location for the selected patient
            fhirBundle.request('/Encounter?_id=' + fhirBundle.encounter.id, { // client.patient.id,
                resolveReferences: ['location'],
                graph: true
            })

            // Reject if no location is found
                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No location found for the selected patient');
                    }
                    return data.entry;
                })

                // Render the current location (or any error)
                .then(
                    function (encounter) {
                        document.getElementById('location').innerText = JSON.stringify(encounter[0].resource.location, null, 4);
                        fhirBundle.fhirBundle.locationResource = encounter[0].resource.location;
                    },
                    function (error) {
                        alert('Issue Fetching Location');
                        document.getElementById('location').innerText = error.stack;
                    }
                );


            // Get Practitioners for the selected patient
            fhirBundle.request('/Patient?_id=' + fhirBundle.patient.id, {
                resolveReferences: ['participant'],
                graph: true
            })


            // Reject if no Practitioners are found
                .then(function (data) {
                    if (!data.entry || !data.entry.length) {
                        throw new Error('No practitioners for the selected patient');
                    }
                    return data.entry;
                })


                // Get Practitioners for the selected patient
                .then(
                    function (practitioner) {
                        document.getElementById('practitioner').innerText = JSON.stringify(practitioner, null, 4);
                        fhirBundle.fhirBundle.practitionerResource = practitioner;
                    },
                    function (error) {
                        document.getElementById('practitioner').innerText = error.stack;
                    }
                );
            clientGlobalScope.client = fhirBundle;
            sessionStorage.setItem('_payload', clientGlobalScope.client);

        }).catch(console.error);

        function returnClient() {
            document.getElementById('headers').innerText = JSON.stringify(clientGlobalScope, null, 4);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://services-strataconnect.stratahealth.net:3141/shssmart', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
            xhr.setRequestHeader('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
            xhr.setRequestHeader('Access-Control-Allow-Credentials', true);
            xhr.setRequestHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, PATCH');

            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status > 400) {
                    if (typeof (Storage) !== 'undefined') {
                        sessionStorage.setItem('_errorDescription', this.responseText);
                        window.location.href = 'onerror.html';
                    } else {
                        alert('Sorry, your browser does not support Web Storage...');
                    }
                }
                if (this.readyState == 4 && this.status == 200) {
                    if (typeof (Storage) !== 'undefined') {
                        var response = JSON.parse(this.responseText);
                        sessionStorage.setItem('patientExists', response.patientExists);
                        sessionStorage.setItem('instanceEnvironment', response.instanceEnvironment);
                        sessionStorage.setItem('organization', response._organization);
                        sessionStorage.setItem('Hospital', response.Hospital);
                        sessionStorage.setItem('firstName', response.firstName);
                        sessionStorage.setItem('lastName', response.lastName);
                        window.location.href = 'createPatient.html';
                    } else {
                        alert('Sorry, your browser does not support Web Storage...');
                    }
                }
                // end of state change: it can be after some time (async)
            };
            xhr.send(JSON.stringify({
                value: clientGlobalScope
            }));
        }
    </script>
</div>
</body>
</html>