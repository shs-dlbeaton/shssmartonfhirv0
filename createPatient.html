<!DOCTYPE html>
<html>
<head>
    <title>SHS Smart App Launch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 25%;
            font-size: 16px;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 3px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-inverse">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">SHS Smart App Launch</a>
        </div>
        <ul class="nav navbar-nav">
            <li class="active"><a href="index.html">EHR Launch</a></li>
            class="caret"></span></a>
            <ul class="dropdown-menu">
            </ul>
            </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
        </ul>
    </div>
</nav>
<div class="jumbotron text-center" style="margin-bottom:0">
    <img src="images/shs_logo2.png" height="128" width="170"/>
    <h2>SHS SMART ON FHIR POC</h2>
    <br/>
    <br/>
    <br/>
    <h3 id="title"></h3>
    <br/>
    <br/>
    <br/>
    <h5 id="showPatientInfo"></h5>
    <br/>
    <br/>
    <h5 id="showPatientDoesNotExist"></h5>
    <br/>
    <br/>
</div>
<h4 id="showSOFEncounters"></h4>
</body>

<script>

    function showPatientDoesNotExist() {
        var text = 'No record found for Patient ' + '<p style="color:blue"><b>' + sessionStorage.getItem('firstName') + ' '
            + sessionStorage.getItem('lastName') + '</b></p>' + '<br/>' + 'Configured Instance: ' + '<p style="color:blue"><b>' + sessionStorage.getItem('Hospital') + '</b></p>' + '<br/>'
            + 'Configured Endpoint: ' + '<p style="color:blue"><b>' + sessionStorage.getItem('instanceEnvironment') + '</b></p>' + '<br/>' + 'EHR Organization name: '
            + '<p style="color:blue"><b>' + sessionStorage.getItem('organization') + '</b></p>' + '<br/>' + ' <button type="button" class="btn btn-primary"">CREATE PATIENT </button>';
        document.getElementById('showPatientInfo').innerHTML = text;
    }


    function showPatientExists() {
        var text = 'Patient ' + '<p style="color:blue"><b>' + sessionStorage.getItem('firstName') + ' ';
        text += sessionStorage.getItem('lastName') + '</b></p>' + ' found' + '<br/>' + 'Configured Instance: ' + '<p style="color:blue"><b>' + sessionStorage.getItem('Hospital') + '</b></p>' + '<br/>';
        text += 'Configured Endpoint: ' + '<p style="color:blue"><b>' + sessionStorage.getItem('instanceEnvironment') + '</b></p>' + '<br/>' + 'EHR Organization name: ';
        text += '<p style="color:blue"><b>' + sessionStorage.getItem('organization') + '</b></p>' + '<br/>';
        document.getElementById('showPatientDoesNotExist').innerHTML = text;

        var txt = '<br><br/>';

        var encountersWithReferrals = JSON.parse(sessionStorage.getItem('encountersWithReferrals'));
        var encountersWithReferralsExists = sessionStorage.getItem('encountersWithReferralsExists');

        if (encountersWithReferralsExists) {

            txt += '<table border=\'1\' class = table2>';
            txt += '<tr><th>CareType Name</th><th>Status</th><th>Service Provider Name</th></tr>';

            function sanitize(input) {
                if (input == undefined)
                    return '';
                else return input;
            }

            encountersWithReferrals.forEach(function (encounterWithReferral) {
                txt += '<tr><td>' + sanitize(encounterWithReferral.careTypeName) + '</td><td>' + sanitize(encounterWithReferral.status) + '</td><td>' + sanitize(encounterWithReferral.serviceProviderName) + '</td></tr>';
            });
            txt += '</table>';
        } else {
            txt += 'Patient ' + '<p style="color:blue"><b>' + sessionStorage.getItem('firstName') + ' '
                + sessionStorage.getItem('lastName') + ' does not have any any existing encounters and referrals in PathWays. Please use the encounter selector to create one for that instance';
        }

        document.getElementById('patientEncountersWithReferrals').innerHTML = txt;

    }

    // Check browser support
    if (typeof (Storage) !== 'undefined') {

        var encounterResource = JSON.parse(sessionStorage.getItem('_encounterByPatientIdResource'));

        createEHREncounterTable(encounterResource);

        var patientExists = sessionStorage.getItem('patientExists');

        if (patientExists == 'false') {
            showPatientDoesNotExist();
        } else if (patientExists == 'true') {
            showPatientExists();
        }

        function createEHREncounterTable(encounterResource) {
            var obj, txt = '';

            obj = {table: 'customers', limit: 20};
            dbParam = JSON.stringify(obj);
            xmlhttp = new XMLHttpRequest();
            txt += '<h3>Show Encounter Selector</h3><br><br><br>';
            txt += '<table border=\'1\'>';
            txt += '<tr><th>Status</th><th>CareType</th><th>Clinical Profile</th><th>Create EHR Encounter In PathWay Instance</th></tr>';

            function sanitizeEncounterTextDiv(encounter) {
                if (encounter && encounter.text && encounter.text.div)
                    return encounter.text.div;
                else return '';
            }

            function sanitize(input) {
                if (input == undefined)
                    return '';
                else return input;
            }

            encounterResource.forEach(function (FHIRresource) {
                var encounter = FHIRresource.resource;
                txt += '<tr><td>' + sanitize(encounter.status) + '</td><td>' + sanitize(encounter.type[0].text) + '</td><td>' + sanitizeEncounterTextDiv(encounter) + '</td><td><button type="button" class="btn btn-primary"">Create / Update Encounter In Instance</button></td></tr>';
            });
            txt += '</table>';
            document.getElementById('showSOFEncounters').innerHTML = txt;
            document.getElementById('title').innerHTML = 'Patient ' + sessionStorage.getItem('firstName') + ' ' + sessionStorage.getItem('lastName') + ' instance ' + sessionStorage.getItem('instanceEnvironment') + ' status';

        }
    } else {
        // Retrieve
        document.getElementById('title').innerHTML = 'Oups, session Storage is not supported by your browser';
    }


</script>
</html>